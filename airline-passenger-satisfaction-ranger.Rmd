---
title: Airline Passenger Satisfaction Parameter Tuning
output: html_document
---

# Title: Airline Passenger Satisfaction Parameter Tuning

# Authors: Maike Hucht, Jule Lang, Micahel Prendota, Deniz Terzioglu

# Date: April 22, 2024

In this notebook, we'll explore a dataset containing information about airline passengers and their satisfaction levels. We'll preprocess the data, build a machine learning model and evaluate the performance.

## Setup

```{r}
# Load libraries
library(tidyverse)
ptm <- proc.time()
library(ranger)
library(mlr)
library(caret)
library(ggplot2)
library(plotly)
```

## Data Loading and Preprocessing

Importing the data

```{r}
data <- read.csv('./data/train.csv')
head(data)
summary(data)
```

```{r}
# Print the column names of the dataset
print(colnames(data))
```

Removing unwanted columns

```{r}
data <- data %>% 
  select(-id)
```

Reporting the amount of missing data
```{r}
# Anzahl der NA-Werte in der Spalte 'Arrival.Delay.in.Minutes' vor der Mutation
na_count <- sum(is.na(data$`Arrival.Delay.in.Minutes`))
print(na_count)
```
Handling missing values

```{r}
# Replace NA values with the mean of the column "Arrival.Delay.in.Minutes"
data <- data %>%
  mutate(`Arrival.Delay.in.Minutes` = if_else(
    is.na(`Arrival.Delay.in.Minutes`), 
    mean(`Arrival.Delay.in.Minutes`, na.rm = TRUE), 
    `Arrival.Delay.in.Minutes`
  ))
```

Encoding categorical variables

```{r}
data$Gender <- ifelse(data$Gender == 'Male', 1, 0)
data$`Customer.Type` <- ifelse(data$`Customer.Type` == 'Loyal Customer', 1, 0)  # Correct column name
data$`Type.of.Travel` <- ifelse(data$`Type.of.Travel` == 'Business travel', 1, 0)  # Correct column name
data$Class <- ifelse(data$Class == 'Business', 1, ifelse(data$Class == 'Eco', 0, -1))
data$satisfaction <- ifelse(data$satisfaction == 'neutral or dissatisfied', 1, 0)
data$satisfaction <- factor(data$satisfaction)
train_data <- data
```




Applying the same steps to test data

```{r}
test_data <- read.csv('./data/test.csv')

test_data <- test_data %>% 
  select(-id)

test_data <- test_data %>%
  mutate(`Arrival.Delay.in.Minutes` = if_else(
    is.na(`Arrival.Delay.in.Minutes`), 
    mean(`Arrival.Delay.in.Minutes`, na.rm = TRUE), 
    `Arrival.Delay.in.Minutes`
  ))
test_data$Gender <- ifelse(test_data$Gender == 'Male', 1, 0)
test_data$`Customer.Type` <- ifelse(test_data$`Customer.Type` == 'Loyal Customer', 1, 0)  # Correct column name
test_data$`Type.of.Travel` <- ifelse(test_data$`Type.of.Travel` == 'Business travel', 1, 0)  # Correct column name
test_data$Class <- ifelse(test_data$Class == 'Business', 1, ifelse(test_data$Class == 'Eco', 0, -1))
test_data$satisfaction <- ifelse(test_data$satisfaction == 'neutral or dissatisfied', 1, 0)


x_train <- train_data %>% 
  select(-satisfaction)
y_train <- train_data$satisfaction

x_test <- test_data %>% 
  select(-satisfaction)
y_test <- factor(test_data$satisfaction)
```

## Model Building and Tuning on data

```{r}
# Define task and learner
task <- makeClassifTask(id = "train_data",
                        data = train_data,
                        target = "satisfaction")

learner <- makeLearner("classif.ranger")

# Choose resampling strategy and define grid
rdesc <- makeResampleDesc("CV", iters = 5)
ps <- makeParamSet(
                   makeIntegerParam("mtry", lower = 3, upper = 4),
                   makeDiscreteParam("num.trees", 200),
                   makeDiscreteParam("respect.unordered.factors", values = c("ignore", "order", "partition"))
                   #makeDiscreteParam("replace", values = c("TRUE" = TRUE, "FALSE" = FALSE))
                   )

# Tune
res = tuneParams(learner, task, rdesc, par.set = ps,
           control = makeTuneControlGrid())

```

Tuning Ergebnisse visualisieren
3 Hyperparameter
```{r}
# Ergebnisse extrahieren
df <- as.data.frame(res$opt.path)

# Scatterplot-Matrix mit Größe der Punkte basierend auf MME erstellen
ggplot(df, aes(x = mtry, y = num.trees, color = respect.unordered.factors, size = mmce.test.mean)) +
  geom_point() +
  facet_grid(. ~ respect.unordered.factors) +
  labs(title = "Hyperparameter Visualisierung",
       x = "mtry", y = "num.trees",
       color = "respect.unordered.factors",
       size = "Mean Misclassification Error") +
  theme_minimal()


```

Tuning Ergebnisse visualisieren
2 Hyperparameter
```{r}
# Ergebnisse extrahieren
df <- as.data.frame(res$opt.path)

# Plot der Ergebnisse als interaktiver 3D-Plot
plot_ly(data = df, x = ~mtry, y = ~num.trees, z = ~mmce.test.mean, type = "scatter3d", mode = "markers",
        marker = list(size = 5, color = ~mmce.test.mean, colorscale = "Viridis")) %>%
  layout(scene = list(xaxis = list(title = "mtry"), yaxis = list(title = "num.trees"), zaxis = list(title = "Mean Misclassification Error")))

```

# Train on  dataset (using best hyperparameters)
```{r}
lrn = setHyperPars(makeLearner("classif.ranger"), par.vals = res$x)
Ranger_model = mlr::train(lrn, task)

print(Ranger_model)
print(proc.time() - ptm)
```

Predict for our test set

```{r}
Ranger_pred = getPredictionResponse(predict(Ranger_model, newdata = x_test))
Ranger_pred
```

```{r}
# Convert both to factors ensuring they have the same levels
levels_set <- union(levels(y_test), levels(Ranger_pred))

y_test <- factor(y_test, levels = levels_set)
task.pred <- factor(Ranger_pred, levels = levels_set)
```

Evaluating model performance

```{r}
acc_ranger <- confusionMatrix(Ranger_pred, y_test)$overall['Accuracy']
acc_ranger
```
```{r}
precision_ranger <- confusionMatrix(Ranger_pred, y_test)$byClass['Precision']
precision_ranger
```
```{r}
recall <- confusionMatrix(Ranger_pred, y_test)$byClass['Recall']

recall
```

```{r}
f1_score <- confusionMatrix(Ranger_pred, y_test)$byClass['F1']
f1_score
```

```{r}
sensitivity <- confusionMatrix(Ranger_pred, y_test)$byClass['Sensitivity']
sensitivity
```

```{r}
specificity <- confusionMatrix(Ranger_pred, y_test)$byClass['Specificity']
specificity
```

```{r}
kappa <- confusionMatrix(Ranger_pred, y_test)$overall['Kappa']
kappa
```

```{r}
auc <- confusionMatrix(Ranger_pred, y_test)$byClass['AUC']
auc
```


## Conclusion

You can copy this markdown content into a Jupyter notebook and execute it with the appropriate kernel (R kernel) to run the R code snippets. Let me know if you need further assistance!
